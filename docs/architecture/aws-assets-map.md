# AWS Assets Map - Backend Deploy

This document maps all AWS resources created by the `backend-deploy` workflow
(`.github/workflows/deploy-backend.yml`).

**Primary API Stack Name:** `evolvesprouts`  
**CDK App:** `backend/infrastructure/bin/app.ts`  
**Stack Definition:** `backend/infrastructure/lib/api-stack.ts`

---

## Frontend static website stacks (S3 + CloudFront)

The same CDK app also defines static website stacks:

- `evolvesprouts-admin-web` (`backend/infrastructure/lib/admin-web-stack.ts`)
- `evolvesprouts-public-www` (`backend/infrastructure/lib/public-www-stack.ts`)

### Public WWW environments in one stack

| Stack Name | Environment | Domain Parameter | Certificate Parameter | Notes |
|-----------|-------------|------------------|-----------------------|-------|
| `evolvesprouts-public-www` | Production | `PublicWwwDomainName` | `PublicWwwCertificateArn` | Production website |
| `evolvesprouts-public-www` | Staging | `PublicWwwStagingDomainName` | `PublicWwwStagingCertificateArn` | Staging website with `X-Robots-Tag: noindex, nofollow, noarchive` |

The stack outputs:

- `PublicWwwBucketName`
- `PublicWwwDistributionId`
- `PublicWwwDistributionDomain`
- `PublicWwwLoggingBucketName`
- `PublicWwwStagingBucketName`
- `PublicWwwStagingDistributionId`
- `PublicWwwStagingDistributionDomain`
- `PublicWwwStagingLoggingBucketName`

Public WWW CloudFront includes:

- Default behavior: static site content from S3 with extensionless path rewrite.
- Additional behavior: `www/*` forwards to `api.evolvesprouts.com` using
  HTTPS-only origin policy, disabled caching, and
  `OriginRequestPolicy.ALL_VIEWER_EXCEPT_HOST_HEADER` so API key headers and
  query parameters pass through while preserving the API origin host header.
- Response headers policy for browser hardening:
  `Strict-Transport-Security`, `X-Content-Type-Options`,
  `X-Frame-Options`, `Referrer-Policy`, `Content-Security-Policy`,
  and `Permissions-Policy`.
  - Public WWW CSP is split by design:
    - CloudFront header CSP enforces `base-uri`, `object-src`, and
      `frame-ancestors` (no `unsafe-inline`).
    - Page-specific CSP is injected at build time into exported HTML
      (`apps/public_www/scripts/inject-csp-meta.mjs`) so each page can
      allow only its own hashed inline scripts.
    - `frame-ancestors` is intentionally omitted from the page-level CSP meta
      because browsers ignore it outside the response header.
- Staging distribution adds `X-Robots-Tag: noindex, nofollow, noarchive`.

---

## CDK Bootstrap Stack (CDKToolkit)

Created once per account/region when `cdk bootstrap` runs. Not part of the main stack but required for deployment.

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| S3 Bucket | `StagingBucket` | `cdk-*-assets-{account}-{region}` | Stores CDK assets (Lambda bundles, etc.) |
| ECR Repository | `StagingRepository` | `cdk-*-container-assets-{account}-{region}` | For container-based assets (unused in this stack) |
| KMS Key | `StagingKey` | Auto-generated | Encrypts assets in S3/ECR |
| IAM Role | `DeployActionRole` | Auto-generated | Role for CDK deployments |
| IAM Role | `FilePublishingRole` | Auto-generated | Role for publishing to S3 |
| IAM Role | `ImagePublishingRole` | Auto-generated | Role for publishing to ECR |
| IAM Role | `LookupRole` | Auto-generated | Role for cross-account lookups |
| SSM Parameter | `/cdk-bootstrap/{qualifier}/version` | `/cdk-bootstrap/*/version` | Tracks bootstrap version |

---

## Application S3 Buckets

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| S3 Bucket | `ClientAssetsBucket` | `evolvesprouts-client-assets-{account}-{region}` | Private bucket for client assets |
| S3 Bucket | `ClientAssetsLogBucket` | `evolvesprouts-client-assets-logs-{account}-{region}` | Access logs for client assets bucket |

## Client asset download CDN (CloudFront)

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| CloudFront Public Key | `AssetDownloadPublicKey` | Auto-generated | Trusted public key for signed client-asset URLs |
| CloudFront Key Group | `AssetDownloadKeyGroup` | Auto-generated | Trusted key group used by client-asset distribution |
| CloudFront Distribution | `ClientAssetsDownloadDistribution` | Auto-generated | Serves private S3 objects through signed URLs only (custom alias from `AssetDownloadCustomDomainName`), with optional WAF WebACL association via `AssetDownloadWafWebAclArn` |

Signed asset links are generated by `EvolvesproutsAdminFunction` using the
configured custom domain (`ASSET_DOWNLOAD_CLOUDFRONT_DOMAIN`), rather than the
default CloudFront hostname.

The client-asset distribution also routes `v1/assets/share/*` to API Gateway,
injects `x-api-key` at origin, and relies on per-link source-domain allowlists
enforced by `EvolvesproutsAdminFunction`.

---

## Network Infrastructure

### VPC and Subnets

**Created only if `EXISTING_VPC_ID` is not provided.**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| VPC | `EvolvesproutsVpc` | `evolvesprouts-vpc` | 2 AZs, no NAT Gateway |
| Internet Gateway | `EvolvesproutsVpcIGW*` | Auto-generated | Attached to VPC |
| Public Subnet | `EvolvesproutsVpcPublicSubnet*` | Auto-generated | 2 subnets (1 per AZ) |
| Private Subnet | `EvolvesproutsVpcPrivateSubnet*` | Auto-generated | 2 isolated subnets (1 per AZ) |
| Route Table | `EvolvesproutsVpcPublicSubnet*RouteTable*` | Auto-generated | Public route table |
| Route Table | `EvolvesproutsVpcPrivateSubnet*RouteTable*` | Auto-generated | Private route table |
| Route | `EvolvesproutsVpcPublicSubnet*DefaultRoute*` | Auto-generated | 0.0.0.0/0 → IGW |
| VPC Gateway Attachment | `EvolvesproutsVpcVPCGW*` | Auto-generated | IGW attachment |

---

## Security Groups

**Created only if corresponding `EXISTING_*_SECURITY_GROUP_ID` is not provided.**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| Security Group | `LambdaSecurityGroup` | `evolvesprouts-lambda-sg` | For Lambda functions (RETAIN policy) |
| Security Group | `MigrationSecurityGroup` | `evolvesprouts-migration-sg` | For migration Lambda (RETAIN policy) |
| Security Group | `DatabaseSecurityGroup` | `evolvesprouts-db-sg` | For Aurora cluster |
| Security Group | `ProxySecurityGroup` | `evolvesprouts-proxy-sg` | For RDS Proxy |

**Security Group Rules (managed automatically unless existing SGs are used):**

| Source SG | Target SG | Port | Description |
|-----------|-----------|------|-------------|
| `ProxySecurityGroup` | `DatabaseSecurityGroup` | 5432 | RDS Proxy → Aurora |
| `LambdaSecurityGroup` | `ProxySecurityGroup` | 5432 | Lambda → RDS Proxy |
| `MigrationSecurityGroup` | `DatabaseSecurityGroup` | 5432 | Migration Lambda → Aurora (direct) |

---

## VPC Endpoints

**Created only when a new VPC is created (not when `EXISTING_VPC_ID` is used).**

| Resource Type | Logical ID | Service | Notes |
|--------------|------------|---------|-------|
| Gateway Endpoint | `S3Endpoint` | S3 | Gateway endpoint (no cost) |
| Interface Endpoint | `SecretsManagerEndpoint` | Secrets Manager | For DB secret access |
| Interface Endpoint | `StsEndpoint` | STS | For IAM auth token generation |
| Interface Endpoint | `CloudWatchLogsEndpoint` | CloudWatch Logs | For Lambda logging |
| Interface Endpoint | `SesEndpoint` | SES | For email sending |
| Interface Endpoint | `SnsEndpoint` | SNS | For notifications |
| Interface Endpoint | `RdsEndpoint` | RDS | For IAM authentication tokens |
| Interface Endpoint | `ApiGatewayEndpoint` | API Gateway | For API key rotation |
| Interface Endpoint | `SqsEndpoint` | SQS | For booking request queue |
| Interface Endpoint | `LambdaEndpoint` | Lambda | For invoking the AWS API proxy from in-VPC Lambdas |

**Note:** Cognito IDP VPC endpoint is **not** included because Cognito
disables PrivateLink when ManagedLogin is configured on the User Pool.
Cognito operations are proxied through `AwsApiProxyFunction` instead.

---

## Database Infrastructure

### Secrets Manager

**Created only if `EXISTING_DB_CREDENTIALS_SECRET_NAME` and `EXISTING_DB_CREDENTIALS_SECRET_ARN` are not provided.**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| Secret | `DBCredentialsSecret` | `evolvesprouts-database-credentials` | Auto-generates password for `postgres` user |

### KMS

**Created only if a new secret is created (not using existing).**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| KMS Key | `DatabaseSecretKey` | Auto-generated | Encrypts database secret (rotation enabled) |
| KMS Alias | `DatabaseSecretKeyAlias*` | Auto-generated | Alias for the key |

### RDS Aurora PostgreSQL Serverless v2

**Created only if `EXISTING_DB_CLUSTER_IDENTIFIER` is not provided.**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| DB Subnet Group | `ClusterSubnets*` | Auto-generated | Private subnets for DB |
| DB Cluster | `Cluster*` | `evolvesprouts-db-cluster` | Aurora Serverless v2, PostgreSQL 16.4 |
| DB Instance | `Cluster*Instance*` | `evolvesprouts-db-writer` | Writer instance (serverless v2) |
| IAM Role | `DatabaseMonitoringRole` | Auto-generated | Enhanced monitoring role |
| DB Parameter Group | `ClusterParameterGroup*` | Auto-generated | PostgreSQL parameters |
| DB Cluster Parameter Group | `ClusterParameterGroup*` | Auto-generated | Cluster-level parameters |

**Cluster Configuration:**
- Engine: Aurora PostgreSQL 16.4
- Min Capacity: 0.5 ACU
- Max Capacity: 2 ACU
- Database Name: `evolvesprouts`
- IAM Authentication: Enabled (if `applyImmutableSettings=true`)
- Storage Encryption: Enabled (if `applyImmutableSettings=true`)
- CloudWatch Logs: `postgresql` export enabled
- Monitoring: Enhanced monitoring (60s interval)

### RDS Proxy

**Created only if `EXISTING_DB_PROXY_NAME` is not provided.**

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| DB Proxy | `Proxy*` | `evolvesprouts-db-proxy` | IAM auth enabled, TLS required |
| DB Proxy Target Group | `ProxyTargetGroup*` | Auto-generated | Targets Aurora cluster |
| DB Proxy Target | `ProxyTarget*` | Auto-generated | Links proxy to cluster |

---

## Cognito Authentication

### User Pool

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| User Pool | `EvolvesproutsUserPool` | `evolvesprouts-user-pool` | Email sign-in, auto-verify enabled; custom attrs `last_auth_time`, legacy `feedback_stars` |
| User Pool Domain | `EvolvesproutsUserPoolDomain` | `{CognitoDomainPrefix}.auth.{region}.amazoncognito.com` | Domain prefix from parameter |
| User Pool Client | `EvolvesproutsUserPoolClient` | Auto-generated | OAuth client (no secret) |
| User Pool Group | `AdminGroup` | `admin` | Admin group |
| User Pool Group | `ManagerGroup` | `manager` | Manager group |

### Identity Providers

| Resource Type | Logical ID | Provider Name | Notes |
|--------------|------------|---------------|-------|
| User Pool Identity Provider | `GoogleIdentityProvider` | `Google` | Google OAuth |

**User Pool Client Configuration:**
- OAuth Flows: `code`
- OAuth Scopes: `openid`, `email`, `profile`
- Supported Providers: `Google`
- Explicit Auth Flows: `ALLOW_CUSTOM_AUTH`, `ALLOW_USER_SRP_AUTH`, `ALLOW_REFRESH_TOKEN_AUTH`

---

## Lambda Functions

Each Lambda function created by `PythonLambda` construct includes:
- Lambda function
- IAM execution role
- KMS key for environment variable encryption
- SQS dead-letter queue

### Application Functions

| Function Logical ID | Handler | Memory | Timeout | VPC | Extra Paths |
|---------------------|---------|--------|---------|-----|-------------|
| `EvolvesproutsAdminFunction` | `lambda/admin/handler.lambda_handler` | 512 MB | 30s | Yes | - |
| `EvolvesproutsMigrationFunction` | `lambda/migrations/handler.lambda_handler` | 512 MB | 5 min | Yes | `db` |
| `HealthCheckFunction` | `lambda/health/handler.lambda_handler` | 256 MB | 10s | Yes | - |

### Auth Functions

| Function Logical ID | Handler | Memory | Timeout | VPC | Notes |
|---------------------|---------|--------|---------|-----|-------|
| `AuthPreSignUpFunction` | `lambda/auth/pre_signup/handler.lambda_handler` | 256 MB | 10s | No | Cognito trigger |
| `AuthDefineChallengeFunction` | `lambda/auth/define_auth_challenge/handler.lambda_handler` | 256 MB | 10s | No | Cognito trigger |
| `AuthCreateChallengeFunction` | `lambda/auth/create_auth_challenge/handler.lambda_handler` | 256 MB | 10s | No | Cognito trigger, SES permissions |
| `AuthVerifyChallengeFunction` | `lambda/auth/verify_auth_challenge/handler.lambda_handler` | 256 MB | 10s | No | Cognito trigger |
| `AuthPostAuthFunction` | `lambda/auth/post_authentication/handler.lambda_handler` | 256 MB | 10s | No | Cognito post-auth trigger |

### Authorizer Functions

| Function Logical ID | Handler | Memory | Timeout | VPC | Notes |
|---------------------|---------|--------|---------|-----|-------|
| `DeviceAttestationAuthorizer` | `lambda/authorizers/device_attestation/handler.lambda_handler` | 256 MB | 5s | No | Device attestation authorizer |
| `AdminGroupAuthorizerFunction` | `lambda/authorizers/cognito_group/handler.lambda_handler` | 256 MB | 5s | No | Admin group authorizer |
| `UserAuthorizerFunction` | `lambda/authorizers/cognito_user/handler.lambda_handler` | 256 MB | 5s | No | Any-user authorizer |

### Other Functions

| Function Logical ID | Handler | Memory | Timeout | VPC | Notes |
|---------------------|---------|--------|---------|-----|-------|
| `AdminBootstrapFunction` | `lambda/admin_bootstrap/handler.lambda_handler` | 256 MB | 30s | Yes | Custom resource handler |
| `AwsApiProxyFunction` | `lambda/aws_proxy/handler.lambda_handler` | 256 MB | 15s | No | AWS/HTTP proxy for in-VPC Lambdas |
| `ApiKeyRotationFunction` | `lambda/api_key_rotation/handler.lambda_handler` | 256 MB | 60s | Yes | Scheduled API key rotation |
| `BookingRequestProcessor` | `lambda/manager_request_processor/handler.lambda_handler` | 512 MB | 10s | Yes | SQS-triggered request processor |

### Lambda Resources Per Function

For each function above, the following resources are created:

| Resource Type | Logical ID Pattern | Notes |
|--------------|-------------------|-------|
| Lambda Function | `{FunctionLogicalID}Function*` | Python 3.12 runtime |
| IAM Role | `{FunctionLogicalID}FunctionServiceRole*` | Execution role |
| IAM Policy | `{FunctionLogicalID}FunctionServiceRoleDefaultPolicy*` | Basic Lambda permissions |
| KMS Key | `{FunctionLogicalID}EnvironmentEncryptionKey*` | Encrypts environment variables (rotation enabled) |
| KMS Alias | `{FunctionLogicalID}EnvironmentEncryptionKeyAlias*` | Alias for the key |
| SQS Queue | `{FunctionLogicalID}DeadLetterQueue*` | DLQ for failed invocations (14-day retention) |
| SQS Queue Policy | `{FunctionLogicalID}DeadLetterQueuePolicy*` | Allows Lambda to send to DLQ |

**Lambda Configuration:**
- Runtime: Python 3.12
- Reserved Concurrency: 25 (default)
- Environment: `PYTHONPATH=/var/task/src`, `LOG_LEVEL=INFO`
- VPC Subnets: Private with egress (if VPC enabled)
- Dead Letter Queue: Enabled

**Additional IAM Permissions:**

| Function | Additional Permissions |
|----------|------------------------|
| `EvolvesproutsAdminFunction` | Read DB secret, connect to RDS Proxy as `evolvesprouts_admin`, invoke `AwsApiProxyFunction`, SNS publish to booking request topic, SES send email, S3 read/write for client assets |
| `AwsApiProxyFunction` | Cognito admin operations (`ListUsers`, `AdminGetUser`, `AdminDeleteUser`, `AdminAddUserToGroup`, `AdminRemoveUserFromGroup`, `AdminListGroupsForUser`, `AdminUserGlobalSignOut`, `AdminUpdateUserAttributes`) |
| `EvolvesproutsMigrationFunction` | Read DB secret, direct connect to Aurora as `postgres`, Cognito user management, CloudFormation invoke permission |
| `HealthCheckFunction` | Read DB secret, connect to RDS Proxy as `evolvesprouts_app` |
| `AuthCreateChallengeFunction` | SES `SendEmail`, `SendRawEmail` for the configured email address |
| `AdminBootstrapFunction` | Cognito `AdminCreateUser`, `AdminUpdateUserAttributes`, `AdminSetUserPassword`, `AdminAddUserToGroup`, CloudFormation invoke permission |
| `ApiKeyRotationFunction` | API Gateway key management, Secrets Manager read/write |
| `BookingRequestProcessor` | Read DB secret, connect to RDS Proxy as `evolvesprouts_admin`, SES send email |

**Lambda Log Groups:**
- Explicitly created by CDK with KMS encryption
- Naming: `/aws/lambda/{function-name}` (e.g., `/aws/lambda/evolvesprouts-EvolvesproutsAdminFunction`)
- 90-day retention policy

---

## API Gateway

### REST API

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| REST API | `EvolvesproutsApi` | `evolvesprouts-api` | Regional REST API |
| Deployment | `EvolvesproutsApiDeployment*` | Auto-generated | Deployment for `prod` stage |
| Stage | `EvolvesproutsApiDeploymentStageprod*` | `prod` | Production stage |

**Stage Configuration:**
- Access Logging: Enabled (custom resource creates/configures `evolvesprouts-api-access-logs`)
- Access Log Format: JSON with standard fields
- Logging Level: INFO
- Data Trace: Disabled
- X-Ray Tracing: Enabled
- Caching: Enabled (0.5 GB cache cluster, encrypted)
- Cache TTL: 5 minutes for `/v1/assets/public/GET`

**CORS Configuration:**
- Allowed Origins: From `CORS_ALLOWED_ORIGINS` env var or context, and always includes `https://www.evolvesprouts.com`, `https://www-staging.evolvesprouts.com`, `https://admin.evolvesprouts.com`, and `https://admin.evolvesprouts.lx-software.com`
- Default Origins (when no env/context is set): `https://www.evolvesprouts.com`, `https://www-staging.evolvesprouts.com`, `https://admin.evolvesprouts.com`, `https://admin.evolvesprouts.lx-software.com`, `capacitor://localhost`, `ionic://localhost`, `http://localhost`, `http://localhost:3000`, `https://evolvesprouts.lx-software.com`, `https://evolvesprouts-api.lx-software.com`
- `EvolvesproutsAdminFunction` receives the resolved CORS list through its `CORS_ALLOWED_ORIGINS` environment variable so Lambda responses and API Gateway preflight behavior stay consistent.
- Allowed Methods: `GET`, `POST`, `PUT`, `DELETE`, `OPTIONS`

### API Gateway Resources and Methods

For the complete list of endpoints with request/response schemas, see
the OpenAPI specs: [`docs/api/public.yaml`](../api/public.yaml)
and [`docs/api/admin.yaml`](../api/admin.yaml).

| Resource Path | Method | Authorization | Integration | Notes |
|--------------|--------|---------------|-------------|-------|
| `/health` | GET | IAM | `HealthCheckFunction` | Health check |
| `/v1/admin/assets` | GET, POST | Admin Group | `EvolvesproutsAdminFunction` | |
| `/v1/admin/assets/{id}` | GET, PUT, DELETE | Admin Group | `EvolvesproutsAdminFunction` | |
| `/v1/admin/assets/{id}/grants` | GET, POST | Admin Group | `EvolvesproutsAdminFunction` | |
| `/v1/admin/assets/{id}/grants/{grantId}` | DELETE | Admin Group | `EvolvesproutsAdminFunction` | |
| `/v1/admin/assets/{id}/share-link` | GET, POST, DELETE | Admin Group | `EvolvesproutsAdminFunction` | Stable bearer link read/create/revoke |
| `/v1/admin/assets/{id}/share-link/rotate` | POST | Admin Group | `EvolvesproutsAdminFunction` | Rotate bearer token and invalidate prior link |
| `/v1/user/assets` | GET | User Auth | `EvolvesproutsAdminFunction` | |
| `/v1/user/assets/{id}/download` | GET | User Auth | `EvolvesproutsAdminFunction` | |
| `/v1/assets/public` | GET | Device Attestation + API Key | `EvolvesproutsAdminFunction` | |
| `/v1/assets/public/{id}/download` | GET | Device Attestation + API Key | `EvolvesproutsAdminFunction` | |
| `/v1/assets/share/{token}` | GET | API Key (CloudFront origin header) | `EvolvesproutsAdminFunction` | Bearer-link resolver (302 redirect) with per-asset source-domain allowlist; restricted assets also require JWT |

### API Gateway Gateway Responses

CORS headers are added to API Gateway error responses so the browser can
read error status codes instead of silently blocking them.
Gateway responses use a static fallback origin plus a response-template
override that echoes the request `Origin` when it matches the configured
allowlist (`CORS_ALLOWED_ORIGINS` plus required defaults).

| Response Type | Headers Added |
|--------------|---------------|
| `DEFAULT_4XX` | `Access-Control-Allow-Origin`, `Access-Control-Allow-Headers`, `Access-Control-Allow-Methods`, `Vary` |
| `DEFAULT_5XX` | `Access-Control-Allow-Origin`, `Access-Control-Allow-Headers`, `Access-Control-Allow-Methods`, `Vary` |

### API Gateway Authorizers

| Resource Type | Logical ID | Type | Handler | Notes |
|--------------|------------|------|---------|-------|
| Request Authorizer | `DeviceAttestationRequestAuthorizer` | Lambda | `DeviceAttestationAuthorizer` | Validates `x-device-attestation` header, no caching |
| Request Authorizer | `AdminGroupAuthorizer` | Lambda | `AdminGroupAuthorizerFunction` | JWT + admin group check, 5-min cache |
| Request Authorizer | `UserAuthorizer` | Lambda | `UserAuthorizerFunction` | JWT validation (any user), 5-min cache |

### API Gateway API Key and Usage Plan

| Resource Type | Logical ID | Physical Name/ID | Notes |
|--------------|------------|------------------|-------|
| API Key | `PublicWwwApiKey` | `evolvesprouts-public-www-key` | Value from `PublicApiKeyValue` parameter |
| Usage Plan | `PublicWwwUsagePlan` | `evolvesprouts-public-www-plan` | Linked to API key and `prod` stage |

### API Gateway IAM Roles

| Resource Type | Logical ID | Purpose | Notes |
|--------------|------------|---------|-------|
| IAM Role | `ApiGatewayLogRole` | CloudWatch Logs | Allows API Gateway to write access logs |

### API Gateway Account Settings

| Resource Type | Logical ID | Notes |
|--------------|------------|-------|
| Account | `ApiGatewayAccount` | Configures CloudWatch role for API Gateway |

**Note:** The access log group `evolvesprouts-api-access-logs` is created and
configured by stack custom resources (including retention and KMS association).

---

## Custom Resources

### Database Migrations

| Resource Type | Logical ID | Handler | Notes |
|--------------|------------|---------|-------|
| Custom Resource | `RunMigrations` | `EvolvesproutsMigrationFunction` | Runs Alembic migrations on stack create/update (triggered by migration hash change) |

**Properties:**
- `MigrationsHash`: SHA256 hash of `backend/db/alembic/versions/` directory
- `SeedHash`: SHA256 hash of `backend/db/seed/seed_data.sql`
- `RunSeed`: value of `RunSeedData` parameter (default `false`)

### Admin Bootstrap

**Created only if `AdminBootstrapEmail` and `AdminBootstrapTempPassword` parameters are provided.**

| Resource Type | Logical ID | Handler | Notes |
|--------------|------------|---------|-------|
| Custom Resource | `AdminBootstrapResource` | `AdminBootstrapFunction` | Creates admin user in Cognito |

**Properties:**
- `UserPoolId`: Cognito User Pool ID
- `Email`: Admin email address
- `TempPassword`: Temporary password
- `GroupName`: `admin`

---

## CloudFormation Parameters

| Parameter Name | Type | Required | NoEcho | Description |
|----------------|------|----------|---------|-------------|
| `CognitoDomainPrefix` | String | Yes | No | Hosted UI domain prefix |
| `CognitoCustomDomainName` | String | No | No | Optional Cognito custom auth domain |
| `CognitoCustomDomainCertificateArn` | String | No | No | ACM ARN for Cognito custom domain |
| `CognitoCallbackUrls` | CommaDelimitedList | Yes | No | OAuth callback URLs |
| `CognitoLogoutUrls` | CommaDelimitedList | Yes | No | OAuth logout URLs |
| `GoogleClientId` | String | Yes | No | Google OAuth client ID |
| `GoogleClientSecret` | String | Yes | Yes | Google OAuth client secret |
| `AuthEmailFromAddress` | String | Yes | No | SES-verified email for passwordless auth |
| `LoginLinkBaseUrl` | String | No | No | Base URL for magic links (default: empty) |
| `MaxChallengeAttempts` | Number | No | No | Max passwordless auth attempts (default: 3) |
| `PublicApiKeyValue` | String | Yes | Yes | API key for public www (min 20 chars) |
| `DeviceAttestationJwksUrl` | String | No | No | JWKS URL for device attestation (default: empty) |
| `DeviceAttestationIssuer` | String | No | No | Expected issuer (default: empty) |
| `DeviceAttestationAudience` | String | No | No | Expected audience (default: empty) |
| `DeviceAttestationFailClosed` | String | No | No | Fail-closed mode (default: `true`, allowed: `true`/`false`) |
| `ActiveCountryCodes` | String | No | No | Comma-separated country codes (default: `HK`) |
| `RunSeedData` | String | No | No | Run seed data after migrations (default: `false`) |
| `SupportEmail` | String | No | No | Email to receive booking request notifications |
| `SesSenderEmail` | String | No | No | SES-verified sender email for notifications |
| `TurnstileSecretKey` | String | No | Yes | Cloudflare Turnstile secret key |
| `ApiCustomDomainName` | String | No | No | Custom domain for the API (default: empty) |
| `ApiCustomDomainCertificateArn` | String | No | No | ACM certificate ARN for API custom domain |
| `NominatimUserAgent` | String | No | No | User-Agent for Nominatim geocoding requests |
| `NominatimReferer` | String | No | No | Referer header for Nominatim requests |
| `AdminBootstrapEmail` | String | No | No | Admin email for bootstrap (default: empty) |
| `AdminBootstrapTempPassword` | String | No | Yes | Temporary password for bootstrap (default: empty) |
| `AssetDownloadCloudFrontPublicKeyPem` | String | Yes | No | PEM-encoded RSA public key for signed asset URLs |
| `AssetDownloadCloudFrontPrivateKeySecretArn` | String | Yes | Yes | Secrets Manager ARN containing CloudFront private key PEM |
| `AssetDownloadCustomDomainName` | String | Yes | No | Custom domain used in signed client-asset download links (for example `media.example.com`) |
| `AssetDownloadCustomDomainCertificateArn` | String | Yes | No | ACM certificate ARN for the client-asset custom domain (must be in `us-east-1`) |
| `AssetDownloadWafWebAclArn` | String | No | No | Optional WAF WebACL ARN for the client-asset download CloudFront distribution (must be in `us-east-1`) |

---

## CloudFormation Outputs

| Output Name | Value | Description |
|-------------|-------|-------------|
| `ApiUrl` | API Gateway REST API URL | Base URL for API endpoints |
| `DatabaseSecretArn` | Secrets Manager secret ARN | ARN of database credentials secret |
| `DatabaseProxyEndpoint` | RDS Proxy endpoint | Endpoint for database connections via proxy |
| `UserPoolId` | Cognito User Pool ID | User Pool identifier |
| `UserPoolClientId` | Cognito User Pool Client ID | OAuth client identifier |
| `ClientAssetsBucketName` | S3 bucket name | Client assets bucket |
| `ClientAssetsLogBucketName` | S3 bucket name | Client assets access logs bucket |
| `ClientAssetsDownloadDistributionDomain` | CloudFront domain | CloudFront distribution hostname backing signed client-asset downloads |
| `ClientAssetsDownloadCloudFrontKeyPairId` | CloudFront key pair ID | Key-Pair-Id used in signed download URLs |
| `ClientAssetsDownloadCustomDomainTarget` | CloudFront domain | DNS CNAME target for the client-asset custom domain |
| `ClientAssetsDownloadCustomDomainUrl` | URL | Custom domain URL used for signed client-asset download links |
| `BookingRequestTopicArn` | SNS topic ARN | Booking request events topic |
| `BookingRequestQueueUrl` | SQS queue URL | Booking request processing queue |
| `BookingRequestDLQUrl` | SQS DLQ URL | Failed booking request messages |
| `CognitoCustomDomainCloudFront` | CloudFront distribution | Custom auth domain target (conditional) |
| `ApiCustomDomainTarget` | CNAME target | API custom domain DNS target (conditional) |
| `ApiCustomDomainUrl` | Custom domain URL | API custom domain URL (conditional) |

---

## Resource Dependencies

### Key Dependencies

1. **VPC** → Security Groups → Database/Lambda
2. **Database Secret** → Aurora Cluster → RDS Proxy
3. **Aurora Cluster** → Migration Lambda (direct access)
4. **RDS Proxy** → Application Lambdas (via proxy)
5. **Cognito User Pool** → Identity Providers → User Pool Client
6. **Cognito User Pool** → Auth Lambda Triggers
7. **Lambda Functions** → API Gateway Integrations
8. **API Gateway** → Usage Plan → API Key
9. **Migration Lambda** → Custom Resource (RunMigrations)
10. **Admin Bootstrap Lambda** → Custom Resource (AdminBootstrapResource)

### Conditional Resources

- **VPC**: Created if `EXISTING_VPC_ID` is not set
- **Security Groups**: Created if corresponding `EXISTING_*_SECURITY_GROUP_ID` is not set
- **Database Secret**: Created if `EXISTING_DB_CREDENTIALS_SECRET_NAME` and `EXISTING_DB_CREDENTIALS_SECRET_ARN` are not set
- **Aurora Cluster**: Created if `EXISTING_DB_CLUSTER_IDENTIFIER` is not set
- **RDS Proxy**: Created if `EXISTING_DB_PROXY_NAME` is not set
- **Admin Bootstrap**: Created if `AdminBootstrapEmail` and `AdminBootstrapTempPassword` are provided

---

## Resource Naming Convention

All resources use the prefix: **`evolvesprouts-`**

Examples:
- VPC: `evolvesprouts-vpc`
- Security Group: `evolvesprouts-lambda-sg`
- Database Cluster: `evolvesprouts-db-cluster`
- User Pool: `evolvesprouts-user-pool`
- API: `evolvesprouts-api`

---

## Tagging Coverage

The stack applies two tags at the stack level:

- `Organization= Evolve Sprouts`
- `Project= Backend`

These tags are inherited by **all taggable resources** created in this
stack, including implicit resources created by CDK (subnets, route
tables, etc.).

Tags are **not guaranteed** on the following:

- Resource types that do not support tagging.
- Imported or existing resources (for example, an existing VPC, DB
  cluster, or security groups).
- Resources created outside the stack lifecycle, such as Lambda log
  groups created on first invocation.
- CDK bootstrap stack resources (CDKToolkit), which are separate from
  this stack.

---

## Resource Retention Policies

Security groups use **update/replace retain** behavior to prevent replacement
failures during stack updates:

- `LambdaSecurityGroup`
- `MigrationSecurityGroup`

Deletion behavior still follows CloudFormation defaults unless resources are
imported/external.

---

## Estimated Resource Count

**Minimum (all existing resources imported):**
- ~50-60 resources (Lambdas, IAM roles, API Gateway resources, etc.)

**Maximum (all resources created):**
- ~150-200 resources (includes VPC, subnets, Aurora, RDS Proxy, all Lambdas with DLQs/KMS, API Gateway, etc.)

---

## Notes

1. **Lambda Log Groups**: Explicitly created by CDK with standard `/aws/lambda/{functionName}` naming and KMS encryption.
2. **API Gateway Access Log Group**: Created and managed by stack custom resources.
3. **Existing Resources**: The workflow detects and imports existing VPC, database, and security group resources to avoid recreation.
4. **CDK Bootstrap**: Required once per account/region. The workflow runs `cdk bootstrap` if needed.
5. **Lambda Bundling**: Lambda code is bundled during `cdk synth` using Docker or local bundle from `.lambda-build/base`.
