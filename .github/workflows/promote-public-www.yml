name: Promote Public Website Release

on:
  repository_dispatch:
    types: [promote-public-www]
  workflow_dispatch:
    inputs:
      promotion_mode:
        description: 'Operation mode'
        required: true
        default: 'latest_staging'
        type: choice
        options:
          - latest_staging
          - release_id
          - maintenance_on
      release_id:
        description: 'Required when promotion_mode=release_id'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: promote-public-www
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate AWS configuration
        run: |
          if [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$AWS_REGION" ]; then
            echo 'AWS_ACCOUNT_ID and AWS_REGION variables are required'
            exit 1
          fi
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ vars.AWS_REGION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Resolve release ID
        id: resolve_release
        run: |
          RESOLVED_PROMOTION_MODE="${PROMOTION_MODE:-latest_staging}"

          if [ "$RESOLVED_PROMOTION_MODE" = "maintenance_on" ]; then
            echo "release_id=" >> "$GITHUB_OUTPUT"
            echo "maintenance_mode=true" >> "$GITHUB_OUTPUT"
            echo "promotion_mode=$RESOLVED_PROMOTION_MODE" >> "$GITHUB_OUTPUT"
            exit 0
          elif [ "$RESOLVED_PROMOTION_MODE" = "release_id" ]; then
            if [ -z "$INPUT_RELEASE_ID" ]; then
              echo 'release_id is required when promotion_mode=release_id'
              exit 1
            fi
            SELECTED_RELEASE_ID="$INPUT_RELEASE_ID"
          elif [ "$RESOLVED_PROMOTION_MODE" = "latest_staging" ]; then
            STAGING_BUCKET="$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='PublicWwwStagingBucketName'].OutputValue" \
              --output text)"
            if [ -z "$STAGING_BUCKET" ] || [ "$STAGING_BUCKET" = "None" ]; then
              echo 'Staging bucket output not found on Public Website stack'
              exit 1
            fi

            MARKER_FILE="$(mktemp)"
            aws s3 cp \
              "s3://$STAGING_BUCKET/releases/latest-release-id.txt" \
              "$MARKER_FILE"
            SELECTED_RELEASE_ID="$(tr -d '\r\n' < "$MARKER_FILE")"
            rm -f "$MARKER_FILE"

            if [ -z "$SELECTED_RELEASE_ID" ]; then
              echo 'Latest staging release marker is empty'
              exit 1
            fi
          else
            echo "Unsupported promotion_mode: $RESOLVED_PROMOTION_MODE"
            exit 1
          fi

          echo "release_id=$SELECTED_RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "maintenance_mode=false" >> "$GITHUB_OUTPUT"
          echo "promotion_mode=$RESOLVED_PROMOTION_MODE" >> "$GITHUB_OUTPUT"
        env:
          PROMOTION_MODE: ${{ inputs.promotion_mode }}
          INPUT_RELEASE_ID: ${{ inputs.release_id }}
          STACK_NAME: evolvesprouts-public-www

      - name: Promote release or enable maintenance mode
        run: |
          if [ -f 'scripts/deploy/deploy-public-www.sh' ]; then
            bash 'scripts/deploy/deploy-public-www.sh'
          else
            echo 'Deploy script not found: scripts/deploy/deploy-public-www.sh'
            exit 1
          fi
        env:
          PUBLIC_WWW_STACK_NAME: evolvesprouts-public-www
          PUBLIC_WWW_ENVIRONMENT: production
          PUBLIC_WWW_MAINTENANCE_MODE: ${{ steps.resolve_release.outputs.maintenance_mode }}
          PUBLIC_WWW_PROMOTE_RELEASE_ID: ${{ steps.resolve_release.outputs.release_id }}

      - name: Publish promotion summary
        run: |
          if [ "$PROMOTION_MODE" = "maintenance_on" ]; then
            {
              echo '## Public Website maintenance mode enabled'
              echo ''
              echo '- Operation mode: `maintenance_on`'
              echo '- Target environment: `production`'
              echo '- Stack: `evolvesprouts-public-www`'
              echo '- Production URL: `https://www.evolvesprouts.com`'
              echo '- `/www/*` CloudFront proxy: `blocked`'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo '## Public Website promotion'
              echo ''
              echo "- Promotion mode: \`${PROMOTION_MODE}\`"
              echo "- Release ID: \`${RELEASE_ID}\`"
              echo '- Source environment: `staging`'
              echo '- Target environment: `production`'
              echo '- Stack: `evolvesprouts-public-www`'
              echo '- Production URL: `https://www.evolvesprouts.com`'
            } >> "$GITHUB_STEP_SUMMARY"
          fi
        env:
          PROMOTION_MODE: ${{ steps.resolve_release.outputs.promotion_mode }}
          RELEASE_ID: ${{ steps.resolve_release.outputs.release_id }}
