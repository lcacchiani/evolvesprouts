name: Promote Public WWW Release

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: 'Staging release ID (usually commit SHA)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: promote-public-www
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate AWS configuration
        run: |
          if [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$AWS_REGION" ]; then
            echo 'AWS_ACCOUNT_ID and AWS_REGION variables are required'
            exit 1
          fi
        env:
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ vars.AWS_REGION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Promote release artifact to production
        run: |
          if [ -f 'scripts/deploy/deploy-public-www.sh' ]; then
            bash 'scripts/deploy/deploy-public-www.sh'
          else
            echo 'Deploy script not found: scripts/deploy/deploy-public-www.sh'
            exit 1
          fi
        env:
          PUBLIC_WWW_SOURCE_STACK_NAME: evolvesprouts-public-www-staging
          PUBLIC_WWW_STACK_NAME: evolvesprouts-public-www
          PUBLIC_WWW_PROMOTE_RELEASE_ID: ${{ inputs.release_id }}

      - name: Publish promotion summary
        run: |
          {
            echo '## Public WWW promotion'
            echo ''
            echo "- Release ID: \`${RELEASE_ID}\`"
            echo '- Source stack: `evolvesprouts-public-www-staging`'
            echo '- Target stack: `evolvesprouts-public-www`'
            echo '- Production URL: `https://www.evolvesprouts.com`'
          } >> "$GITHUB_STEP_SUMMARY"
        env:
          RELEASE_ID: ${{ inputs.release_id }}
