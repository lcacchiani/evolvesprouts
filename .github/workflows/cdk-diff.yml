name: CDK Diff

on:
  repository_dispatch:
    types: [cdk-diff]
  workflow_dispatch:
    inputs:
      stacks:
        description: 'Optional space/comma-separated CDK stack names'
        required: false
        default: ''

permissions:
  contents: read
  id-token: write

concurrency:
  group: cdk-diff
  cancel-in-progress: false

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: backend/infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Install infrastructure dependencies
        working-directory: backend/infrastructure
        run: npm ci

      - name: Run CDK diff
        working-directory: backend/infrastructure
        run: |
          npx cdk acknowledge 34892 || true
          npm run build --if-present
          QUALIFIER_ARGS=()
          if [ -n "$CDK_BOOTSTRAP_QUALIFIER" ]; then
            QUALIFIER_ARGS=(--qualifier "$CDK_BOOTSTRAP_QUALIFIER")
          fi
          STACK_ARGS=()
          if [ -n "${CDK_STACKS:-}" ]; then
            IFS=$', \n\t' read -r -a STACK_LIST <<< "$CDK_STACKS"
            for stack in "${STACK_LIST[@]}"; do
              trimmed="${stack#"${stack%%[![:space:]]*}"}"
              trimmed="${trimmed%"${trimmed##*[![:space:]]}"}"
              if [ -n "$trimmed" ]; then
                STACK_ARGS+=("$trimmed")
              fi
            done
          fi
          if [ ${#STACK_ARGS[@]} -gt 0 ]; then
            npx cdk diff --no-color "${QUALIFIER_ARGS[@]}" "${STACK_ARGS[@]}"
          else
            npx cdk diff --no-color "${QUALIFIER_ARGS[@]}"
          fi
        env:
          CDK_STACKS: ${{ inputs.stacks }}
          CDK_BOOTSTRAP_QUALIFIER: ${{ vars.CDK_BOOTSTRAP_QUALIFIER }}
