name: Generate Figma OAuth Refresh Token

# Usage:
#   1. Construct the Figma authorization URL (see the job summary or
#      the figma/README.md in apps/public_www).
#   2. Open it in your browser and click Allow.
#   3. Copy the `code` from the redirect URL in your browser address bar.
#   4. Trigger this workflow with the code pasted into authorization_code.
#
# The workflow exchanges the code immediately and stores the refresh
# token as a repository secret.

on:
  workflow_dispatch:
    inputs:
      authorization_code:
        description: 'Figma authorization code from the redirect URL'
        required: true
        type: string
      callback_port:
        description: 'Port used in the callback URL (must match Figma app settings)'
        required: false
        default: '3845'
        type: string

permissions:
  contents: read

jobs:
  exchange-code:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          ERRORS=0
          if [ -z "$CLIENT_ID" ]; then
            echo '::error::FIGMA_OAUTH_CLIENT_ID secret is not set.'
            ERRORS=1
          fi
          if [ -z "$CLIENT_SECRET" ]; then
            echo '::error::FIGMA_OAUTH_CLIENT_SECRET secret is not set.'
            ERRORS=1
          fi
          if [ "$ERRORS" -eq 1 ]; then exit 1; fi
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}

      - name: Exchange authorization code for tokens
        id: exchange
        run: |
          python3 << 'PYEOF'
          import json, os, sys, urllib.request, urllib.parse

          client_id     = os.environ["CLIENT_ID"]
          client_secret = os.environ["CLIENT_SECRET"]
          auth_code     = os.environ["AUTH_CODE"].strip()
          port          = os.environ.get("CALLBACK_PORT", "3845").strip()
          redirect_uri  = f"http://localhost:{port}/callback"

          # --- Debug (no secrets) ---
          print(f"redirect_uri : {redirect_uri}")
          print(f"code length  : {len(auth_code)}")
          print(f"code prefix  : {auth_code[:8]}...")
          print(f"client_id len: {len(client_id)}")
          print()

          # --- Try the exchange ---
          body = urllib.parse.urlencode({
              "client_id":     client_id,
              "client_secret": client_secret,
              "redirect_uri":  redirect_uri,
              "code":          auth_code,
              "grant_type":    "authorization_code",
          }).encode()

          req = urllib.request.Request(
              "https://api.figma.com/v1/oauth/token",
              data=body,
              headers={"Content-Type": "application/x-www-form-urlencoded"},
              method="POST",
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read().decode())
          except urllib.error.HTTPError as exc:
              err_body = exc.read().decode()[:500]
              print(f"::error::Token exchange failed (HTTP {exc.code}): {err_body}")

              # Write debug info for the summary step
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("exchange_ok=false\n")
                  f.write(f"error_detail=HTTP {exc.code}: {err_body}\n")

              sys.exit(1)

          refresh_token = data.get("refresh_token", "")
          access_token  = data.get("access_token", "")
          expires_in    = data.get("expires_in", "?")
          user_id       = data.get("user_id", "")

          if not refresh_token:
              print(f"::error::No refresh_token in response: {json.dumps(data)[:500]}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("exchange_ok=false\n")
              sys.exit(1)

          # Mask tokens in logs
          print(f"::add-mask::{refresh_token}")
          if access_token:
              print(f"::add-mask::{access_token}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"exchange_ok=true\n")
              f.write(f"refresh_token={refresh_token}\n")
              f.write(f"expires_in={expires_in}\n")
              f.write(f"user_id={user_id}\n")

          print()
          print("Token exchange successful!")
          print(f"  user_id    : {user_id}")
          print(f"  expires_in : {expires_in}s")
          PYEOF
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}
          AUTH_CODE: ${{ inputs.authorization_code }}
          CALLBACK_PORT: ${{ inputs.callback_port }}

      - name: Store refresh token as secret
        if: ${{ steps.exchange.outputs.exchange_ok == 'true' }}
        run: |
          echo "${REFRESH_TOKEN}" | gh secret set FIGMA_OAUTH_REFRESH_TOKEN
          echo 'FIGMA_OAUTH_REFRESH_TOKEN secret has been updated.'
        env:
          REFRESH_TOKEN: ${{ steps.exchange.outputs.refresh_token }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish result summary
        if: always()
        run: |
          PORT="${CALLBACK_PORT:-3845}"
          REDIRECT_URI="http://localhost:${PORT}/callback"
          ENCODED_REDIRECT=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${REDIRECT_URI}', safe=''))")
          AUTH_URL="https://www.figma.com/oauth?client_id=${CLIENT_ID}&redirect_uri=${ENCODED_REDIRECT}&scope=file_content:read&state=$(openssl rand -hex 16)&response_type=code"

          {
            echo '## Figma OAuth Refresh Token'
            echo ''

            if [ "$EXCHANGE_OK" = "true" ]; then
              echo '### Status: Success'
              echo ''
              echo 'The \`FIGMA_OAUTH_REFRESH_TOKEN\` repository secret has been created/updated automatically.'
              echo ''
              echo '| Detail | Value |'
              echo '|--------|-------|'
              echo "| Figma user ID | \`${USER_ID:-n/a}\` |"
              echo "| Access token expires in | ${EXPIRES_IN:-?}s |"
              echo ''
              echo 'If automatic secret storage failed (permissions), add the secret manually'
              echo 'under **Settings > Secrets and variables > Actions**.'
            else
              echo '### Status: Failed'
              echo ''
              echo "Error: \`${ERROR_DETAIL:-unknown}\`"
              echo ''
              echo '### Debugging checklist'
              echo ''
              echo '1. **Callback URL match** — verify the Figma app callback URL is'
              echo "   exactly \`${REDIRECT_URI}\` (no trailing slash, no https)."
              echo '2. **Code copied correctly** — copy only the value between'
              echo '   \`?code=\` and \`&state=\` from the browser address bar.'
              echo '3. **Code not reused** — each code can only be exchanged once.'
              echo '   Re-open the authorization URL below to get a fresh code.'
              echo '4. **Code not expired** — authorize and trigger the workflow'
              echo '   within a few minutes.'
              echo ''
              echo '### How to retry'
              echo ''
              echo '1. Open the authorization URL below in your browser.'
              echo '2. Click **Allow** on the Figma page.'
              echo "3. Figma redirects to \`${REDIRECT_URI}?code=XXXXX&state=...\`"
              echo '   The page will not load — that is expected.'
              echo '4. Copy the \`code\` value from the address bar'
              echo '   (between \`?code=\` and \`&state=\`).'
              echo '5. Go to **Actions > Generate Figma OAuth Refresh Token > Run workflow**,'
              echo '   paste the code, and click **Run workflow**.'
            fi

            echo ''
            echo '---'
            echo ''
            echo '### Authorization URL'
            echo ''
            echo 'Open this in your browser to authorize (or re-authorize):'
            echo ''
            echo "\`\`\`"
            echo "${AUTH_URL}"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CALLBACK_PORT: ${{ inputs.callback_port }}
          EXCHANGE_OK: ${{ steps.exchange.outputs.exchange_ok }}
          ERROR_DETAIL: ${{ steps.exchange.outputs.error_detail }}
          EXPIRES_IN: ${{ steps.exchange.outputs.expires_in }}
          USER_ID: ${{ steps.exchange.outputs.user_id }}
