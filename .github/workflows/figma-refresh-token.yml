name: Generate Figma OAuth Refresh Token

# Usage:
#   1. Construct the Figma authorization URL (see the job summary or
#      the figma/README.md in apps/public_www).
#   2. Open it in your browser and click Allow.
#   3. Copy the `code` from the redirect URL in your browser address bar.
#   4. Trigger this workflow with the code pasted into authorization_code.
#
# The workflow exchanges the code immediately and stores the refresh
# token as a repository secret.

on:
  workflow_dispatch:
    inputs:
      authorization_code:
        description: 'Figma authorization code from the redirect URL'
        required: true
        type: string
      callback_port:
        description: 'Port used in the callback URL (must match Figma app settings)'
        required: false
        default: '3845'
        type: string

permissions:
  contents: read

jobs:
  exchange-code:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs and secrets
        run: |
          ERRORS=0

          if [ -z "$CLIENT_ID" ]; then
            echo '::error::FIGMA_OAUTH_CLIENT_ID secret is not set.'
            ERRORS=1
          fi
          if [ -z "$CLIENT_SECRET" ]; then
            echo '::error::FIGMA_OAUTH_CLIENT_SECRET secret is not set.'
            ERRORS=1
          fi
          if [ -z "$AUTH_CODE" ]; then
            echo '::error::authorization_code input is required.'
            ERRORS=1
          fi

          if [ "$ERRORS" -eq 1 ]; then
            exit 1
          fi
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}
          AUTH_CODE: ${{ inputs.authorization_code }}

      - name: Exchange authorization code for tokens
        id: exchange
        run: |
          PORT="${CALLBACK_PORT:-3845}"
          REDIRECT_URI="http://localhost:${PORT}/callback"
          TOKEN_URL="https://api.figma.com/v1/oauth/token"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${TOKEN_URL}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${CLIENT_ID}" \
            --data-urlencode "client_secret=${CLIENT_SECRET}" \
            --data-urlencode "redirect_uri=${REDIRECT_URI}" \
            --data-urlencode "code=${AUTH_CODE}" \
            --data-urlencode "grant_type=authorization_code")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "exchange_ok=false" >> "$GITHUB_OUTPUT"
            echo "error_status=${HTTP_CODE}" >> "$GITHUB_OUTPUT"
            echo "error_body=${BODY}" >> "$GITHUB_OUTPUT"
            echo "::error::Token exchange failed with HTTP ${HTTP_CODE}: ${BODY}"
            exit 1
          fi

          REFRESH_TOKEN=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('refresh_token',''))")
          ACCESS_TOKEN=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('access_token',''))")
          EXPIRES_IN=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('expires_in','?'))")
          USER_ID=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('user_id',''))")

          if [ -z "$REFRESH_TOKEN" ]; then
            echo "exchange_ok=false" >> "$GITHUB_OUTPUT"
            echo "::error::No refresh_token in response: ${BODY}"
            exit 1
          fi

          # Mask tokens in logs.
          echo "::add-mask::${REFRESH_TOKEN}"
          if [ -n "$ACCESS_TOKEN" ]; then
            echo "::add-mask::${ACCESS_TOKEN}"
          fi

          echo "exchange_ok=true" >> "$GITHUB_OUTPUT"
          echo "refresh_token=${REFRESH_TOKEN}" >> "$GITHUB_OUTPUT"
          echo "expires_in=${EXPIRES_IN}" >> "$GITHUB_OUTPUT"
          echo "user_id=${USER_ID}" >> "$GITHUB_OUTPUT"
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}
          AUTH_CODE: ${{ inputs.authorization_code }}
          CALLBACK_PORT: ${{ inputs.callback_port }}

      - name: Store refresh token as secret
        if: ${{ steps.exchange.outputs.exchange_ok == 'true' }}
        run: |
          echo "${REFRESH_TOKEN}" | gh secret set FIGMA_OAUTH_REFRESH_TOKEN
          echo 'FIGMA_OAUTH_REFRESH_TOKEN secret has been updated.'
        env:
          REFRESH_TOKEN: ${{ steps.exchange.outputs.refresh_token }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish result summary
        if: always()
        run: |
          PORT="${CALLBACK_PORT:-3845}"
          REDIRECT_URI="http://localhost:${PORT}/callback"
          ENCODED_REDIRECT=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${REDIRECT_URI}', safe=''))")
          AUTH_URL="https://www.figma.com/oauth?client_id=${CLIENT_ID}&redirect_uri=${ENCODED_REDIRECT}&scope=file_content:read&state=$(openssl rand -hex 16)&response_type=code"

          {
            echo '## Figma OAuth Refresh Token'
            echo ''

            if [ "$EXCHANGE_OK" = "true" ]; then
              echo '### Status: Success'
              echo ''
              echo 'The \`FIGMA_OAUTH_REFRESH_TOKEN\` repository secret has been created/updated automatically.'
              echo ''
              echo '| Detail | Value |'
              echo '|--------|-------|'
              echo "| Figma user ID | \`${USER_ID:-n/a}\` |"
              echo "| Access token expires in | ${EXPIRES_IN:-?}s |"
              echo ''
              echo 'If automatic secret storage failed (permissions), add the secret manually'
              echo 'under **Settings > Secrets and variables > Actions**.'
            else
              echo '### Status: Failed'
              echo ''
              echo 'The authorization code may have expired before the runner started.'
              echo 'Figma codes are short-lived — you need to authorize and trigger the'
              echo 'workflow quickly.'
              echo ''
              echo '### How to retry'
              echo ''
              echo '**Tip:** Open both tabs side-by-side before you start:'
              echo '- Tab 1: The authorization URL below'
              echo '- Tab 2: **Actions > Generate Figma OAuth Refresh Token > Run workflow**'
              echo ''
              echo '1. Open the authorization URL below in **Tab 1**.'
              echo '2. Click **Allow** on the Figma page.'
              echo "3. Figma redirects to \`${REDIRECT_URI}?code=XXXXX&state=...\`"
              echo '   The page will not load — that is expected.'
              echo '4. Copy the \`code\` value from the address bar'
              echo '   (between \`?code=\` and \`&state=\`).'
              echo '5. Switch to **Tab 2**, paste the code, and click **Run workflow**.'
            fi

            echo ''
            echo '---'
            echo ''
            echo '### Authorization URL'
            echo ''
            echo 'Open this in your browser to authorize (or re-authorize):'
            echo ''
            echo "\`\`\`"
            echo "${AUTH_URL}"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
        env:
          CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          CALLBACK_PORT: ${{ inputs.callback_port }}
          EXCHANGE_OK: ${{ steps.exchange.outputs.exchange_ok }}
          EXPIRES_IN: ${{ steps.exchange.outputs.expires_in }}
          USER_ID: ${{ steps.exchange.outputs.user_id }}
