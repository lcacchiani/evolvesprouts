name: Export Figma Homepage Artifact

on:
  push:
    branches:
      - cursor/public-website-design-9b60
    paths:
      - '.github/workflows/figma-export-homepage-artifact.yml'
  workflow_dispatch:
    inputs:
      node_id:
        description: 'Figma node id to export'
        required: false
        default: '0:1229'
        type: string

permissions:
  contents: read

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: apps/public_www/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: apps/public_www

      - name: Pull Figma tokens
        run: npm run figma:pull
        working-directory: apps/public_www
        env:
          FIGMA_OAUTH_ACCESS_TOKEN: ${{ secrets.FIGMA_OAUTH_ACCESS_TOKEN }}
          FIGMA_OAUTH_CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          FIGMA_OAUTH_CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}
          FIGMA_OAUTH_REFRESH_TOKEN: ${{ secrets.FIGMA_OAUTH_REFRESH_TOKEN }}
          FIGMA_OAUTH_TOKEN_URL: ${{ vars.PUBLIC_WWW_FIGMA_OAUTH_TOKEN_URL }}
          FIGMA_FILE_KEY: ${{ vars.PUBLIC_WWW_FIGMA_FILE_KEY }}

      - name: Export target node metadata and image
        working-directory: apps/public_www
        env:
          FIGMA_OAUTH_ACCESS_TOKEN: ${{ secrets.FIGMA_OAUTH_ACCESS_TOKEN }}
          FIGMA_OAUTH_CLIENT_ID: ${{ secrets.FIGMA_OAUTH_CLIENT_ID }}
          FIGMA_OAUTH_CLIENT_SECRET: ${{ secrets.FIGMA_OAUTH_CLIENT_SECRET }}
          FIGMA_OAUTH_REFRESH_TOKEN: ${{ secrets.FIGMA_OAUTH_REFRESH_TOKEN }}
          FIGMA_OAUTH_TOKEN_URL: ${{ vars.PUBLIC_WWW_FIGMA_OAUTH_TOKEN_URL }}
          FIGMA_FILE_KEY: ${{ vars.PUBLIC_WWW_FIGMA_FILE_KEY }}
          TARGET_NODE_ID: ${{ inputs.node_id }}
        run: |
          node <<'NODE'
          import { writeFile } from 'node:fs/promises';
          import path from 'node:path';

          function getEnv(name) {
            return process.env[name]?.trim() ?? '';
          }

          async function getJson(url, accessToken) {
            const response = await fetch(url, {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            });
            if (!response.ok) {
              const body = await response.text();
              throw new Error(
                `Request failed (${response.status}) for ${url}: ${body.slice(0, 500)}`,
              );
            }
            return response.json();
          }

          async function resolveAccessToken() {
            const directToken = getEnv('FIGMA_OAUTH_ACCESS_TOKEN');
            if (directToken) {
              return directToken;
            }

            const clientId = getEnv('FIGMA_OAUTH_CLIENT_ID');
            const clientSecret = getEnv('FIGMA_OAUTH_CLIENT_SECRET');
            const refreshToken = getEnv('FIGMA_OAUTH_REFRESH_TOKEN');
            const tokenUrl =
              getEnv('FIGMA_OAUTH_TOKEN_URL') ||
              'https://api.figma.com/v1/oauth/token';

            if (!clientId || !clientSecret || !refreshToken) {
              throw new Error(
                'Missing OAuth env vars: FIGMA_OAUTH_CLIENT_ID, FIGMA_OAUTH_CLIENT_SECRET, FIGMA_OAUTH_REFRESH_TOKEN',
              );
            }

            const body = new URLSearchParams({
              grant_type: 'refresh_token',
              client_id: clientId,
              client_secret: clientSecret,
              refresh_token: refreshToken,
            });
            const response = await fetch(tokenUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body,
            });
            if (!response.ok) {
              const text = await response.text();
              throw new Error(
                `Token exchange failed (${response.status}): ${text.slice(0, 500)}`,
              );
            }
            const payload = await response.json();
            const accessToken = payload.access_token?.trim?.() ?? '';
            if (!accessToken) {
              throw new Error('Token response missing access_token.');
            }
            return accessToken;
          }

          function collectTextNodes(node, output = []) {
            if (!node || typeof node !== 'object') {
              return output;
            }

            if (node.type === 'TEXT' && node.characters?.trim()) {
              const style = node.style ?? {};
              const bounds = node.absoluteBoundingBox ?? {};
              output.push({
                id: node.id,
                name: node.name,
                text: node.characters,
                x: bounds.x,
                y: bounds.y,
                width: bounds.width,
                height: bounds.height,
                fontFamily: style.fontFamily,
                fontStyle: style.fontPostScriptName,
                fontWeight: style.fontWeight,
                fontSize: style.fontSize,
                lineHeightPx: style.lineHeightPx,
                letterSpacing: style.letterSpacing,
                textAlignHorizontal: style.textAlignHorizontal,
                textAlignVertical: style.textAlignVertical,
                fills: node.fills,
              });
            }

            const children = Array.isArray(node.children) ? node.children : [];
            for (const child of children) {
              collectTextNodes(child, output);
            }

            return output;
          }

          async function main() {
            const fileKey = getEnv('FIGMA_FILE_KEY');
            const nodeId = getEnv('TARGET_NODE_ID') || '0:1229';
            if (!fileKey) {
              throw new Error('FIGMA_FILE_KEY is required.');
            }

            const accessToken = await resolveAccessToken();
            const outputDir = path.join('figma', 'files');

            const nodeJson = await getJson(
              `https://api.figma.com/v1/files/${fileKey}/nodes?ids=${encodeURIComponent(nodeId)}`,
              accessToken,
            );
            await writeFile(
              path.join(outputDir, 'homepage-node.json'),
              `${JSON.stringify(nodeJson, null, 2)}\n`,
              'utf8',
            );

            const targetNode = nodeJson.nodes?.[nodeId]?.document;
            if (!targetNode) {
              throw new Error(`Node ${nodeId} was not returned by Figma.`);
            }

            const textNodes = collectTextNodes(targetNode).sort((a, b) => {
              const ay = a.y ?? 0;
              const by = b.y ?? 0;
              if (ay !== by) {
                return ay - by;
              }
              return (a.x ?? 0) - (b.x ?? 0);
            });
            await writeFile(
              path.join(outputDir, 'homepage-text.json'),
              `${JSON.stringify(textNodes, null, 2)}\n`,
              'utf8',
            );

            const imageJson = await getJson(
              `https://api.figma.com/v1/images/${fileKey}?ids=${encodeURIComponent(nodeId)}&format=png&scale=2`,
              accessToken,
            );
            const imageUrl = imageJson.images?.[nodeId];
            if (!imageUrl) {
              throw new Error(`Image URL missing for node ${nodeId}.`);
            }

            const imageResponse = await fetch(imageUrl);
            if (!imageResponse.ok) {
              const body = await imageResponse.text();
              throw new Error(
                `Failed to download image (${imageResponse.status}): ${body.slice(0, 500)}`,
              );
            }
            const imageBuffer = Buffer.from(await imageResponse.arrayBuffer());
            await writeFile(path.join(outputDir, 'homepage-image.png'), imageBuffer);

            console.log(`Exported node ${nodeId} into figma/files/.`);
          }

          await main();
          NODE

      - name: Upload homepage export artifact
        uses: actions/upload-artifact@v4
        with:
          name: figma-homepage-export
          path: |
            apps/public_www/figma/files/file.json
            apps/public_www/figma/files/variables.local.json
            apps/public_www/figma/files/homepage-node.json
            apps/public_www/figma/files/homepage-text.json
            apps/public_www/figma/files/homepage-image.png
